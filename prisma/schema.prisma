generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum AccountType {
  CHEQUING
  SAVINGS
  CREDIT_CARD
  CASH
  INVESTMENT
}

enum CategoryType {
  INCOME
  EXPENSE
  TRANSFER
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum TransactionStatus {
  PENDING
  POSTED
  REVERSED
  FLAGGED
}

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum FintracRiskLevel {
  LOW
  MEDIUM
  HIGH
}

model User {
  id                String           @id @default(cuid())
  email             String           @unique
  fullName          String?          @db.VarChar(120)
  defaultCurrency   String           @default("CAD") @db.VarChar(3)
  countryCode       String           @default("CA") @db.VarChar(2)
  provinceCode      String?          @db.VarChar(2)
  fintracRiskLevel  FintracRiskLevel @default(LOW)
  fintracReviewedAt DateTime?
  accounts          Account[]
  transactions      Transaction[]
  categories        Category[]
  budgets           Budget[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  deletedAt         DateTime?

  @@map("users")
}

model Account {
  id                 String        @id @default(cuid())
  userId             String
  name               String        @db.VarChar(120)
  institutionName    String?       @db.VarChar(120)
  accountNumberLast4 String?       @db.VarChar(4)
  type               AccountType
  currency           String        @default("CAD") @db.VarChar(3)
  openingBalance     Decimal       @default(0) @db.Decimal(14, 2)
  currentBalance     Decimal       @default(0) @db.Decimal(14, 2)
  isActive           Boolean       @default(true)
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions       Transaction[]
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  deletedAt          DateTime?

  @@index([userId])
  @@index([type])
  @@map("accounts")
}

model Category {
  id           String        @id @default(cuid())
  userId       String
  name         String        @db.VarChar(100)
  type         CategoryType
  isSystem     Boolean       @default(false)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  budgets      Budget[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime?

  @@unique([userId, name, type])
  @@index([userId, type])
  @@map("categories")
}

model Budget {
  id           String        @id @default(cuid())
  userId       String
  categoryId   String?
  name         String        @db.VarChar(120)
  period       BudgetPeriod  @default(MONTHLY)
  periodStart  DateTime
  periodEnd    DateTime
  limitAmount  Decimal       @db.Decimal(14, 2)
  spentAmount  Decimal       @default(0) @db.Decimal(14, 2)
  currency     String        @default("CAD") @db.VarChar(3)
  isActive     Boolean       @default(true)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  category     Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime?

  @@index([userId, periodStart, periodEnd])
  @@index([categoryId])
  @@map("budgets")
}

model Transaction {
  id                String            @id @default(cuid())
  userId            String
  accountId         String
  categoryId        String
  budgetId          String?
  type              TransactionType
  status            TransactionStatus @default(POSTED)
  amount            Decimal           @db.Decimal(14, 2)
  currency          String            @default("CAD") @db.VarChar(3)
  description       String?           @db.VarChar(255)
  merchantName      String?           @db.VarChar(120)
  referenceCode     String?           @db.VarChar(64)
  transactionAt     DateTime
  postedAt          DateTime?
  fintracReportable Boolean           @default(false)
  fintracReportedAt DateTime?
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  account           Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category          Category          @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  budget            Budget?           @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?

  @@index([userId, transactionAt(sort: Desc)])
  @@index([accountId, transactionAt(sort: Desc)])
  @@index([categoryId])
  @@index([budgetId])
  @@index([status])
  @@index([fintracReportable, transactionAt(sort: Desc)])
  @@map("transactions")
}
