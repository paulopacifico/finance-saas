generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum AccountType {
  CHEQUING
  SAVINGS
  CREDIT_CARD
  CASH
  INVESTMENT
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

model Profile {
  id              String            @id @db.Uuid
  fullName        String?
  defaultCurrency String            @default("CAD") @db.VarChar(3)
  householdsOwned Household[]       @relation("HouseholdOwner")
  households      HouseholdMember[]
  accounts        Account[]
  transactions    Transaction[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?

  @@map("profiles")
}

model Household {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String            @db.VarChar(120)
  ownerId      String            @db.Uuid
  owner        Profile           @relation("HouseholdOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  members      HouseholdMember[]
  accounts     Account[]
  transactions Transaction[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  deletedAt    DateTime?

  @@index([ownerId])
  @@map("households")
}

model HouseholdMember {
  householdId String    @db.Uuid
  profileId   String    @db.Uuid
  role        String    @default("member") @db.VarChar(32)
  createdAt   DateTime  @default(now())
  deletedAt   DateTime?
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@id([householdId, profileId])
  @@index([profileId])
  @@map("household_members")
}

model Account {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  householdId    String        @db.Uuid
  ownerId        String?       @db.Uuid
  name           String        @db.VarChar(120)
  type           AccountType
  currency       String        @default("CAD") @db.VarChar(3)
  openingBalance Decimal       @default(0) @db.Decimal(14, 2)
  currentBalance Decimal       @default(0) @db.Decimal(14, 2)
  household      Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  owner          Profile?      @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  transactions   Transaction[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?

  @@index([householdId])
  @@index([ownerId])
  @@map("accounts")
}

model Transaction {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  householdId String          @db.Uuid
  accountId   String          @db.Uuid
  createdById String?         @db.Uuid
  type        TransactionType
  description String?         @db.VarChar(255)
  amount      Decimal         @db.Decimal(14, 2)
  occurredAt  DateTime
  household   Household       @relation(fields: [householdId], references: [id], onDelete: Cascade)
  account     Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  createdBy   Profile?        @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deletedAt   DateTime?

  @@index([householdId, occurredAt(sort: Desc)])
  @@index([accountId, occurredAt(sort: Desc)])
  @@index([createdById])
  @@map("transactions")
}
